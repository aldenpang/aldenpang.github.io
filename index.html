<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Excel Converter - Easily Extract Tables from PDF</title>
    <meta name="description" content="Free online tool to convert PDF files to Excel spreadsheets. Select table areas in your PDF and extract data accurately with OCR technology.">
    <meta name="keywords" content="pdf to excel, convert pdf to excel, pdf table extraction, ocr pdf to excel, pdf data extraction, free pdf converter">
    <link rel="canonical" href="https://yourdomain.com/pdf2excel.html" />
    <meta property="og:title" content="PDF to Excel Converter - Easily Extract Tables from PDF" />
    <meta property="og:description" content="Free online tool to convert PDF files to Excel spreadsheets. Select table areas and extract data accurately." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://yourdomain.com/pdf2excel.html" />
    <meta property="og:image" content="https://yourdomain.com/preview-image.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="PDF to Excel Converter - Easily Extract Tables from PDF" />
    <meta name="twitter:description" content="Free online tool to convert PDF files to Excel spreadsheets. Select table areas and extract data accurately." />
    <meta name="twitter:image" content="https://yourdomain.com/preview-image.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3748573797751725"
         crossorigin="anonymous"></script>
    <style>
        .upload-btn {
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .upload-btn:hover {
            background-color: #45a049;
        }
        
        .container {
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: calc(100vh - 50px);
            padding: 20px;
        }

        .pdf-container {
            max-width: 100%;
            overflow: auto;
            position: relative;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            background-color: #f0f0f0;
            margin-bottom: 20px;
            min-height: 500px;
        }
        
        #pdfViewer {
            display: block;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .controls-container {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        /* 增加画布容器尺寸 */
        .canvas-container {
            min-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .page-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .page-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .page-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 14px;
            color: #666;
        }

        .selection-box {
            position: absolute;
            border: 2px solid #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
            pointer-events: none;
        }

        .content-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1600px;
            gap: 20px;
            margin-top: 20px;
        }

        .pdf-side {
            flex: 1;
            min-width: 0;
        }

        .preview-side {
            border-left: none;
            border-bottom: 1px solid #ddd;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
        }

        .preview-wrapper {
            position: relative;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding-right: 30px;
        }

        .preview-image {
            display: block;
            width: 300px;
            height: auto;
            border-right: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: contain;
            background-color: white;
        }
        
        .delete-btn {
            position: absolute;
            top: 50%;
            right: 3px;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: red;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 添加语言选择器样式 */
        .language-selector {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 1001;
        }

        .language-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .language-selector select:hover {
            border-color: #4CAF50;
        }

        #pdfViewerContainer {
            max-width: 100%;
            overflow: auto;
            position: relative;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            background-color: #f0f0f0;
            margin-bottom: 20px;
            min-height: 500px;
        }
        
        #pdfViewer {
            display: block;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .controls-container {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        /* 增加画布容器尺寸 */
        .canvas-container {
            min-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            min-height: 150px;
        }
        
        .preview-wrapper:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .preview-image {
            width: 300px;
            height: auto;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: contain;
            background-color: white;
        }
        
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: red;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 添加全屏预览功能 */
        .fullscreen-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .fullscreen-preview img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background: red;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }

        .controls-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .action-btn:hover {
            background-color: #0b7dda;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* .convertBtn {
            background-color: #4CAF50;
        }

        .convertBtn:hover:not([disabled]) {
            background-color: #45a049;
        } */
        
        .convert-btn {
            padding: 12px 24px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .convert-btn:hover {
            background-color: #1976D2;
        }
        
        .convert-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .file-input {
            margin-right: 10px;
            cursor: pointer;
        }

        .file-input::-webkit-file-upload-button {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .file-input::-webkit-file-upload-button:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="google-ads">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3748573797751725"
        crossorigin="anonymous"></script>
       <!-- pdf2excel -->
       <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-3748573797751725"
           data-ad-slot="7485597563"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
       <script>
           (adsbygoogle = window.adsbygoogle || []).push({});
       </script>
    </div>
    <div class="language-selector">
        <select id="languageSelect" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="zh">中文</option>
            <option value="fr">Français</option>
            <option value="ja">日本語</option>
            <option value="ko">한국어</option>
        </select>
    </div>
    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="color: #333; font-weight:bold; font-size: 2em; margin-bottom: 10px;">
                PDF to Excel Converter
            </h1>
            <h2 style="color: #666; font-weight: normal; font-size: 1.2em;">
                Steps: 1. Upload PDF → 2. Select Areas → 3. Generate Excel → Done!
            </h2>
        </div>
        <div style="text-align: center;">
            <input type="file" 
                   id="fileInput" 
                   accept=".pdf" 
                   style="display: none">
            <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Upload PDF File
                </button>
                <button id="convertBtn" class="convert-btn" onclick="convertToExcel()" disabled>
                    Convert to Excel
                </button>
            </div>
            <p id="fileInfo" style="margin-top: 10px; color: #666;"></p>
        </div>
        <div class="content-wrapper">
            <div class="preview-side" id="previewContainer">
                <!-- 预览区域 -->
            </div>
            <div class="pdf-side">
                <div id="pdfViewerContainer" style="position: relative;">
                    <canvas id="pdfViewer" class="pdf-container" style="display: none;"></canvas>
                </div>
                <div class="page-controls" style="display: none;">
                    <button id="prevPage" class="page-btn">Previous</button>
                    <span id="pageInfo" class="page-info">Page 1 of 1</span>
                    <button id="nextPage" class="page-btn">Next</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentPDF = null;
        let currentPage = 1;
        let isSelecting = false;
        let startX, startY;
        let selectionBox = null;

        async function renderPage(pageNum) {
            // 使用正确的PDF容器ID
            const pdfContainer = document.getElementById('pdfViewerContainer');
            const canvas = document.getElementById('pdfViewer');
            const ctx = canvas.getContext('2d');
            
            // 获取当前页
            const page = await currentPDF.getPage(pageNum);
            
            // 计算缩放比例，使PDF适应容器宽度但保持较高分辨率
            const containerWidth = pdfContainer ? pdfContainer.clientWidth : window.innerWidth * 0.8;
            const viewport = page.getViewport({ scale: 1 });
            
            // 使用更高的缩放因子以提高分辨率
            const desiredWidth = containerWidth - 20; // 留出一些边距
            const scale = Math.max(1.5, desiredWidth / viewport.width);
            
            // 创建高分辨率视口
            const scaledViewport = page.getViewport({ scale: scale });
            
            // 设置canvas尺寸为视口尺寸
            canvas.width = scaledViewport.width;
            canvas.height = scaledViewport.height;
            
            // 使用设备像素比进一步提高分辨率
            const pixelRatio = window.devicePixelRatio || 1;
            canvas.width = scaledViewport.width * pixelRatio;
            canvas.height = scaledViewport.height * pixelRatio;
            
            // 设置canvas CSS尺寸
            canvas.style.width = `${scaledViewport.width}px`;
            canvas.style.height = `${scaledViewport.height}px`;
            
            // 缩放绘图上下文以匹配设备像素比
            ctx.scale(pixelRatio, pixelRatio);
            
            // 渲染PDF页面
            const renderContext = {
                canvasContext: ctx,
                viewport: scaledViewport,
                enableWebGL: true,
                renderInteractiveForms: true
            };
            
            try {
                await page.render(renderContext).promise;
                
                // 更新当前页码显示
                document.getElementById('pageInfo').textContent = `Page ${pageNum} of ${currentPDF.numPages}`;
                document.getElementById('prevPage').disabled = pageNum <= 1;
                document.getElementById('nextPage').disabled = pageNum >= currentPDF.numPages;
                currentPage = pageNum;
                
                // 显示PDF查看器
                document.getElementById('pdfViewerContainer').style.display = 'block';
                canvas.style.display = 'block';
            } catch (error) {
                console.error('Error rendering PDF page:', error);
            }
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileInfo').textContent = `Selected file: ${file.name}`;
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const typedarray = new Uint8Array(arrayBuffer);
                    
                    console.log('Starting PDF loading...');
                    currentPDF = await pdfjsLib.getDocument({data: typedarray}).promise;
                    console.log('PDF loaded successfully, pages:', currentPDF.numPages);
                    
                    currentPage = 1;
                    
                    document.getElementById('pdfViewer').style.display = 'block';
                    document.getElementById('pdfViewerContainer').style.display = 'block';
                    document.querySelector('.page-controls').style.display = 'flex';
                    
                    await renderPage(currentPage);
                } catch (error) {
                    console.error('PDF loading error:', error);
                    alert('Failed to load PDF: ' + error.message);
                }
            }
        });

        document.getElementById('prevPage').addEventListener('click', async () => {
            if (currentPage > 1) {
                currentPage--;
                await renderPage(currentPage);
            }
        });

        document.getElementById('nextPage').addEventListener('click', async () => {
            if (currentPDF && currentPage < currentPDF.numPages) {
                currentPage++;
                await renderPage(currentPage);
            }
        });

        function initializeSelection() {
            console.log("初始化选择功能...");
            const canvas = document.getElementById('pdfViewer');
            const pdfContainer = document.getElementById('pdfViewerContainer');
            
            // 确保预览容器存在
            let previewContainer = document.getElementById('previewContainer');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'previewContainer';
                previewContainer.className = 'preview-container';
                document.querySelector('.pdf-tools').appendChild(previewContainer);
            }
            
            // 鼠标按下时开始选择
            canvas.addEventListener('mousedown', function(e) {
                console.log("鼠标按下", e);
                const rect = canvas.getBoundingClientRect();
                startX = (e.clientX - rect.left) * (canvas.width / rect.width);
                startY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                isSelecting = true;
                
                // 创建选择框
                if (selectionBox) {
                    selectionBox.remove();
                }
                
                selectionBox = document.createElement('div');
                selectionBox.className = 'selection-box';
                selectionBox.style.position = 'absolute';
                selectionBox.style.border = '2px dashed red';
                selectionBox.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
                selectionBox.style.pointerEvents = 'none';
                pdfContainer.appendChild(selectionBox);
            });
            
            // 鼠标移动时更新选择框
            canvas.addEventListener('mousemove', function(e) {
                if (!isSelecting || !selectionBox) return;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                const canvasLeft = canvas.offsetLeft;
                const canvasTop = canvas.offsetTop;
                
                const left = Math.min(startX, currentX * (canvas.width / rect.width)) / (canvas.width / rect.width) + canvasLeft;
                const top = Math.min(startY, currentY * (canvas.height / rect.height)) / (canvas.height / rect.height) + canvasTop;
                const width = Math.abs(currentX * (canvas.width / rect.width) - startX) / (canvas.width / rect.width);
                const height = Math.abs(currentY * (canvas.height / rect.height) - startY) / (canvas.height / rect.height);
                
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
            });
            
            // 鼠标松开时完成选择
            canvas.addEventListener('mouseup', function(e) {
                if (!isSelecting || !selectionBox) return;
                
                isSelecting = false;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = (e.clientX - rect.left) * (canvas.width / rect.width);
                const currentY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                // 计算选择区域
                const x = Math.min(startX, currentX);
                const y = Math.min(startY, currentY);
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);
                
                // 验证选择区域大小
                if (width < 10 || height < 10) {
                    if (selectionBox && selectionBox.parentNode) {
                        selectionBox.parentNode.removeChild(selectionBox);
                    }
                    selectionBox = null;
                    return;
                }
                
                // 创建并添加截图
                const previewWrapper = createScreenshot(canvas, x, y, width, height);
                
                // 添加到预览容器
                const previewContainer = document.getElementById('previewContainer');
                if (previewContainer) {
                    previewContainer.appendChild(previewWrapper);
                }
                
                // 显示转换按钮
                const convertBtn = document.getElementById('convertBtn');
                if (convertBtn) {
                    convertBtn.style.display = 'block';
                    convertBtn.disabled = false;
                }
                else{
                    console.log("转换按钮不存在");
                }
                
                // 清理选择框 - 确保移除选择框
                if (selectionBox && selectionBox.parentNode) {
                    selectionBox.parentNode.removeChild(selectionBox);
                }
                selectionBox = null;
                
                console.log("选框已取消，截图已添加到预览区域");
            });
            
            // 清理
            canvas.addEventListener('mouseleave', function() {
                if (isSelecting && selectionBox) {
                    isSelecting = false;
                    selectionBox.remove();
                    selectionBox = null;
                }
            });
        }

        // 添加语言翻译配置
        const translations = {
            en: {
                steps: "Steps: 1. Upload PDF → 2. Select Areas → 3. Generate Excel → Done!",
                uploadBtn: "Upload PDF File",
                prevPage: "Previous",
                nextPage: "Next",
                pageInfo: "Page {current} of {total}",
                deleteBtn: "Delete",
                adBanner: "🔥 Special Offer: Online PDF Processing Tool - Click to Learn More",
                convertBtn: "Convert to CSV",
                featureInDev: "This feature is coming soon! We're working hard to bring you table recognition and Excel conversion.",
                processing: "Processing...",
                processingProgress: "Processing {current}/{total}..."
            },
            zh: {
                steps: "步骤：1. 上传PDF → 2. 选择区域 → 3. 生成Excel表格 → 完成！",
                uploadBtn: "上传PDF文件",
                prevPage: "上一页",
                nextPage: "下一页",
                pageInfo: "第 {current} 页，共 {total} 页",
                deleteBtn: "删除",
                adBanner: "🔥 特惠：在线PDF处理工具 - 点击了解更多",
                convertBtn: "转换为CSV",
                featureInDev: "此功能即将推出！我们正在努力开发表格识别和Excel转换功能。",
                processing: "处理中...",
                processingProgress: "正在处理 {current}/{total}..."
            },
            fr: {
                steps: "Étapes : 1. Télécharger PDF → 2. Sélectionner zones → 3. Générer Excel → Terminé !",
                uploadBtn: "Télécharger PDF",
                prevPage: "Précédent",
                nextPage: "Suivant",
                pageInfo: "Page {current} sur {total}",
                deleteBtn: "Supprimer",
                adBanner: "🔥 Offre Spéciale : Outil de traitement PDF en ligne - Cliquez pour en savoir plus",
                convertBtn: "Convertir en CSV",
                featureInDev: "Cette fonctionnalité sera bientôt disponible ! Nous travaillons sur la reconnaissance de tableaux et la conversion Excel.",
                processing: "En cours de traitement...",
                processingProgress: "Traitement {current}/{total}..."
            },
            ja: {
                steps: "手順：1. PDFをアップロード → 2. 領域を選択 → 3. Excelを生成 → 完了！",
                uploadBtn: "PDFをアップロード",
                prevPage: "前へ",
                nextPage: "次へ",
                pageInfo: "ページ {current}/{total}",
                deleteBtn: "削除",
                adBanner: "🔥 特別オファー：オンラインPDF処理ツール - 詳細はこちら",
                convertBtn: "CSVに変換",
                featureInDev: "この機能は近日公開予定です！表の認識とExcel変換機能を開発中です。",
                processing: "処理中...",
                processingProgress: "処理中 {current}/{total}..."
            },
            ko: {
                steps: "단계: 1. PDF 업로드 → 2. 영역 선택 → 3. Excel 생성 → 완료!",
                uploadBtn: "PDF 업로드",
                prevPage: "이전",
                nextPage: "다음",
                pageInfo: "페이지 {current}/{total}",
                deleteBtn: "삭제",
                adBanner: "🔥 특별 제공: 온라인 PDF 처리 도구 - 자세히 알아보기",
                convertBtn: "CSV로 변환",
                featureInDev: "이 기능은 곧 제공될 예정입니다! 표 인식 및 Excel 변환 기능을 개발 중입니다.",
                processing: "처리중...",
                processingProgress: "처리중 {current}/{total}..."
            }
        };

        // 添加语言切换函数
        function changeLanguage(lang) {
            const t = translations[lang];
            
            // 更新步骤说明
            document.querySelector('h2').textContent = t.steps;
            
            // 更新上传按钮
            document.querySelector('.upload-btn').textContent = t.uploadBtn;
            
            // 更新页面控制按钮
            document.getElementById('prevPage').textContent = t.prevPage;
            document.getElementById('nextPage').textContent = t.nextPage;
            
            // 更新页码信息
            const currentPageInfo = document.getElementById('pageInfo').textContent;
            const matches = currentPageInfo.match(/\d+/g);
            if (matches && matches.length === 2) {
                document.getElementById('pageInfo').textContent = 
                    t.pageInfo.replace('{current}', matches[0]).replace('{total}', matches[1]);
            }
            
            // 更新广告横幅
            document.querySelector('.ad-banner a').textContent = t.adBanner;
            
            // 更新所有删除按钮
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.textContent = t.deleteBtn;
            });
            
            // 更新转换按钮
            document.getElementById('convertBtn').textContent = t.convertBtn;
        }

        // 修改生成文件的函数，从Excel改为CSV
        function generateCsvFile(allTableData) {
            // 将所有表格数据合并为一个数组，表格之间用空行分隔
            const mergedData = allTableData.reduce((acc, table, tableIndex) => {
                if (tableIndex > 0) acc.push([]); // 添加空行分隔不同表格
                return acc.concat(table);
            }, []);
            
            // 转换为CSV格式
            const csvContent = mergedData.map(row => {
                return row.map(cell => {
                    // 处理逗号、换行符和引号等特殊字符
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(',');
            }).join('\n');
            
            // 添加UTF-8 BOM标记，确保Excel正确识别中文
            const bomPrefix = '\uFEFF';
            
            // 创建Blob对象
            const blob = new Blob([bomPrefix + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'table_data.csv';
            
            // 添加到文档并触发点击
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        // 修改图像处理函数以生成正确的base64格式
        async function prepareImageForAPI(imgSrc) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 使用DeepSeek推荐尺寸
                        const maxSize = 512; 
                        let width = img.width;
                        let height = img.height;
                        
                        // 计算新尺寸，保持宽高比
                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round(height * (maxSize / width));
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round(width * (maxSize / height));
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // 绘制白色背景
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, width, height);
                        
                        // 绘制图像
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 生成base64 URL格式
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl); // 返回完整的data URL
                    } catch (error) {
                        reject(error);
                    }
                };
                img.onerror = reject;
                img.src = imgSrc;
            });
        }

        // 修改convertToExcel函数，完全删除状态显示
        async function convertToExcel() {
            const previewContainer = document.getElementById('previewContainer');
            const screenshots = previewContainer.getElementsByClassName('preview-image');
            
            if (screenshots.length === 0) {
                alert(translations[document.getElementById('languageSelect').value].noScreenshots || '请先从PDF中选择区域');
                return;
            }
            else
            {
                console.info('选中截图个数：'+screenshots.length);
            }

            try {
                const convertBtn = document.getElementById('convertBtn');
                const originalText = convertBtn.textContent;
                convertBtn.disabled = true;
                convertBtn.textContent = translations[document.getElementById('languageSelect').value].processing;

                // 直接加载OCR引擎，不显示状态
                let worker;
                try {
                    worker = await Tesseract.createWorker({
                        logger: m => {
                            console.log(m);
                        }
                    });
                    
                    // 配置OCR
                    await worker.loadLanguage('eng+chi_sim');
                    await worker.initialize('eng+chi_sim');
                    await worker.setParameters({
                        tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.,-+/*()%:;?!@#$&=<>[]{}_\\|~"\'',
                        preserve_interword_spaces: '1'
                    });
                } catch (error) {
                    console.error('OCR引擎初始化失败:', error);
                    convertBtn.disabled = false;
                    convertBtn.textContent = originalText;
                    alert('OCR引擎初始化失败: ' + error.message);
                    return;
                }

                let allTableData = [];
                
                // 处理每个截图
                for (let i = 0; i < screenshots.length; i++) {
                    const img = screenshots[i];
                    
                    console.log(`处理图片 ${i+1}/${screenshots.length}...`);
                    
                    try {
                        // 使用OCR识别图片
                        const { data } = await worker.recognize(img.src);
                        
                        // 处理OCR结果为表格数据
                        const tableData = extractTableFromOCR(data);
                        
                        if (tableData.length > 0) {
                            allTableData.push(tableData);
                            console.log(`图片 ${i+1}/${screenshots.length} 处理完成，识别到 ${tableData.length} 行数据`);
                        } else {
                            console.log(`图片 ${i+1}/${screenshots.length} 未识别到表格数据`);
                            allTableData.push([['无法识别表格数据']]);
                        }
                    } catch (error) {
                        console.error(`处理图片 ${i+1} 失败:`, error);
                        
                        allTableData.push([
                            [`图片 ${i+1} 处理失败`],
                            ['错误信息: ' + error.message],
                            ['请手动查看原始PDF并录入数据']
                        ]);
                    }
                }
                
                // 终止OCR工作器
                await worker.terminate();
                
                if (allTableData.length === 0) {
                    throw new Error('未检测到有效表格数据');
                }
                
                // 生成CSV
                console.log('生成CSV文件...');
                generateCsvFile(allTableData);
                
                // 恢复按钮状态
                convertBtn.disabled = false;
                convertBtn.textContent = originalText;
                
            } catch (error) {
                console.error('转换错误:', error);
                alert('转换失败: ' + error.message);
                
                const convertBtn = document.getElementById('convertBtn');
                convertBtn.disabled = false;
                convertBtn.textContent = translations[document.getElementById('languageSelect').value].convertBtn;
            }
        }

        // 添加表格提取函数
        function extractTableFromOCR(ocrData) {
            const lines = ocrData.text.split('\n').filter(line => line.trim() !== '');
            
            // 创建表格数据
            const tableData = [];
            
            // 识别表格结构
            for (const line of lines) {
                // 尝试拆分行内数据为单元格
                let cells;
                
                if (line.includes('|')) {
                    // 如果有|分隔符，按|分隔
                    cells = line.split('|').map(cell => cell.trim());
                } else if (line.includes('\t')) {
                    // 如果有制表符，按制表符分隔
                    cells = line.split('\t').map(cell => cell.trim());
                } else {
                    // 尝试按多个空格分隔（2个以上空格）
                    cells = line.split(/\s{2,}/).map(cell => cell.trim()).filter(cell => cell !== '');
                    
                    // 如果分割后只有一个单元格，尝试基于位置信息拆分
                    if (cells.length <= 1 && ocrData.words) {
                        cells = splitLineByPositions(line, ocrData.words);
                    }
                }
                
                // 如果仍然只有一个单元格，则保持原样
                if (cells.length <= 1) {
                    cells = [line.trim()];
                }
                
                // 处理每个单元格，查找日期
                const processedCells = [];
                const foundDates = [];
                
                for (const cell of cells) {
                    // 检查单元格是否包含日期
                    const dateInfo = extractDateFromText(cell);
                    
                    if (dateInfo.hasDate) {
                        // 如果包含日期，添加原始单元格内容和提取出的日期
                        processedCells.push(dateInfo.textWithoutDate);
                        foundDates.push(dateInfo.date);
                    } else {
                        // 没有日期，保持原样
                        processedCells.push(cell);
                    }
                }
                
                // 添加日期列（如果有）
                const rowData = [...processedCells];
                if (foundDates.length > 0) {
                    // 添加所有找到的日期作为单独的列
                    rowData.push(...foundDates);
                }
                
                // 添加到表格数据
                tableData.push(rowData);
            }
            
            return tableData;
        }

        // 修正从文本中提取日期的函数，确保正确识别JUL18格式
        function extractDateFromText(text) {
            const result = {
                hasDate: false,
                date: '',
                textWithoutDate: text
            };
            
            // 月份名称映射
            const monthMap = {
                'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 
                'MAY': '05', 'JUN': '06', 'JUL': '07', 'AUG': '08', 
                'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
            };
            
            // 常见日期格式的正则表达式
            const datePatterns = [
                // 特别处理JUL18这种紧凑格式，放在第一位
                {
                    regex: /(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(\d{1,2})/gi,
                    format: (month, day) => {
                        const year = new Date().getFullYear();
                        const monthNum = monthMap[month.toUpperCase()];
                        return `${year}-${monthNum}-${day.padStart(2, '0')}`;
                    }
                },
                // 其他的英文月份格式
                {
                    regex: /\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s+(\d{1,2})\b/gi,
                    format: (month, day) => {
                        const year = new Date().getFullYear();
                        const monthNum = monthMap[month.toUpperCase()];
                        return `${year}-${monthNum}-${day.padStart(2, '0')}`;
                    }
                },
                // 保留原有的日期格式
                {
                    regex: /\b(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\b/g,
                    format: (y, m, d) => `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`
                },
                {
                    regex: /\b(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})\b/g,
                    format: (d, m, y) => `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`
                },
                {
                    regex: /\b(\d{4})年(\d{1,2})月(\d{1,2})日\b/g,
                    format: (y, m, d) => `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`
                },
                {
                    regex: /\b(\d{1,2})月(\d{1,2})日\b/g,
                    format: (m, d) => {
                        const year = new Date().getFullYear();
                        return `${year}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                    }
                }
            ];
            
            // 添加调试输出
            console.log("检查日期文本:", text);
            
            let modifiedText = text;
            
            // 检查所有日期模式
            for (const pattern of datePatterns) {
                const matches = [...text.matchAll(pattern.regex)];
                console.log("模式匹配结果:", pattern.regex, matches.length > 0 ? matches : "无匹配");
                
                if (matches.length > 0) {
                    for (const match of matches) {
                        // 提取日期部分
                        const matchedText = match[0];
                        console.log("匹配到日期:", matchedText, match);
                        
                        // 应用格式化
                        if (match.length === 4) { // 三部分日期
                            result.date = pattern.format(match[1], match[2], match[3]);
                        } else if (match.length === 3) { // 两部分日期
                            result.date = pattern.format(match[1], match[2]);
                        }
                        
                        // 从文本中移除日期
                        modifiedText = modifiedText.replace(matchedText, '').trim();
                        
                        // 只处理找到的第一个日期
                        result.hasDate = true;
                        result.textWithoutDate = modifiedText;
                        console.log("处理后结果:", result);
                        break;
                    }
                    
                    // 如果找到了日期，就不再检查其他模式
                    if (result.hasDate) break;
                }
            }
            
            return result;
        }

        // 基于位置信息拆分行
        function splitLineByPositions(line, words) {
            // 找到属于这一行的所有words
            const lineWords = words.filter(word => 
                line.includes(word.text) && 
                word.text.trim() !== ''
            );
            
            // 按照x坐标排序
            lineWords.sort((a, b) => a.bbox.x0 - b.bbox.x0);
            
            // 检测间隔，找出可能的列边界
            const gaps = [];
            for (let i = 1; i < lineWords.length; i++) {
                const gap = lineWords[i].bbox.x0 - lineWords[i-1].bbox.x1;
                gaps.push({
                    index: i,
                    size: gap
                });
            }
            
            // 按间隔大小排序
            gaps.sort((a, b) => b.size - a.size);
            
            // 取最大的几个间隔作为列分隔点（根据数据复杂度可调整数量）
            const columnBreaks = gaps.slice(0, Math.min(4, Math.floor(gaps.length / 2)))
                .sort((a, b) => a.index - b.index)
                .map(g => g.index);
            
            // 根据分隔点将词组合为单元格
            const cells = [];
            let currentCell = [];
            
            for (let i = 0; i < lineWords.length; i++) {
                currentCell.push(lineWords[i].text);
                
                if (columnBreaks.includes(i+1) || i === lineWords.length - 1) {
                    cells.push(currentCell.join(' '));
                    currentCell = [];
                }
            }
            
            return cells;
        }

        // 修改createScreenshot函数，确保转换按钮显示
        function createScreenshot(canvas, x, y, width, height) {
            // 创建截图
            const screenshotCanvas = document.createElement('canvas');
            const ctx = screenshotCanvas.getContext('2d');
            
            // 设置更高分辨率
            const scaleFactor = 3; // 增加到3倍分辨率
            screenshotCanvas.width = width * scaleFactor;
            screenshotCanvas.height = height * scaleFactor;
            
            // 启用高质量图像渲染
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // 绘制选中区域
            ctx.drawImage(
                canvas, 
                x, y, width, height,
                0, 0, screenshotCanvas.width, screenshotCanvas.height
            );
            
            // 创建预览图片
            const previewImg = new Image();
            previewImg.className = 'preview-image';
            previewImg.src = screenshotCanvas.toDataURL('image/png');
            
            // 让图片可点击查看大图
            previewImg.onclick = function() {
                showFullscreenPreview(this.src);
            };
            
            // 创建删除按钮
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                previewWrapper.remove();
                updateConvertButtonState();
            };
            
            // 创建预览包装容器
            const previewWrapper = document.createElement('div');
            previewWrapper.className = 'preview-wrapper';
            previewWrapper.appendChild(previewImg);
            previewWrapper.appendChild(deleteBtn);
            
            // 添加到末尾
            updateConvertButtonState();
            return previewWrapper;
        }

        // 初始化函数，确保页面中有预览容器和按钮区域
        function initializeUI() {
            // 确保预览容器存在
            let previewContainer = document.getElementById('previewContainer');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'previewContainer';
                previewContainer.className = 'preview-container';
                
                // 查找PDF工具区域并添加
                const pdfTools = document.querySelector('.pdf-tools');
                if (pdfTools) {
                    pdfTools.appendChild(previewContainer);
                } else {
                    // 如果找不到，添加到body
                    document.body.appendChild(previewContainer);
                }
            }
            
            // 创建转换按钮，但默认隐藏
            const convertBtn = document.getElementById('convertBtn');
            convertBtn.style.display = 'none';
        }

        // 强制初始化选择功能
        (function forceInitialize() {
            console.log("开始强制初始化...");
            
            // 直接调用初始化函数
            setTimeout(function() {
                console.log("正在调用initializeSelection...");
                if (typeof initializeSelection === 'function') {
                    initializeSelection();
                    console.log("initializeSelection函数已调用");
                } else {
                    console.error("initializeSelection函数不存在！");
                }
            }, 2000);
            
            // 修改PDF加载函数，确保在加载PDF时也初始化选择功能
            const originalLoadPDF = window.loadPDF;
            if (typeof originalLoadPDF === 'function') {
                window.loadPDF = function(file) {
                    console.log("拦截到PDF加载，将在加载后初始化选择功能");
                    const result = originalLoadPDF.call(this, file);
                    
                    // 在PDF加载后，确保初始化选择功能
                    setTimeout(function() {
                        console.log("PDF已加载，初始化选择功能");
                        initializeSelection();
                    }, 1000);
                    
                    return result;
                };
            }
            
            // 监听PDF渲染完成事件
            document.addEventListener('pdfrendered', function() {
                console.log("检测到PDF渲染完成事件，初始化选择功能");
                setTimeout(initializeSelection, 500);
            });
            
            // 轮询检查PDF是否已经加载
            const checkPDFLoaded = function() {
                const canvas = document.getElementById('pdfViewer');
                if (canvas) {
                    console.log("发现PDF画布，初始化选择功能");
                    initializeSelection();
                } else {
                    console.log("未找到PDF画布，继续等待...");
                    setTimeout(checkPDFLoaded, 1000);
                }
            };
            
            // 开始轮询
            setTimeout(checkPDFLoaded, 1000);
            
            // 添加直接调用函数到window对象
            window.forceInitializeSelection = function() {
                console.log("手动触发初始化");
                initializeSelection();
            };
            
            console.log("强制初始化设置完成");
        })();

        // 确保选择功能被初始化，修复事件监听逻辑
        function ensureSelectionInitialized() {
            console.log("确保选择功能被初始化...");
            
            // 将initializeSelection添加到全局对象，方便调试
            window.initializeSelection = initializeSelection;
            
            // 显示调试按钮
            const debugBtn = document.createElement('button');
            debugBtn.textContent = "初始化选择功能";
            debugBtn.style.position = "fixed";
            debugBtn.style.top = "10px";
            debugBtn.style.right = "10px";
            debugBtn.style.zIndex = "9999";
            debugBtn.style.padding = "5px 10px";
            debugBtn.style.backgroundColor = "#ff9800";
            debugBtn.style.color = "white";
            debugBtn.style.border = "none";
            debugBtn.style.borderRadius = "4px";
            debugBtn.style.cursor = "pointer";
            
            debugBtn.addEventListener('click', function() {
                console.log("手动点击初始化选择功能");
                initializeSelection();
            });
            
            document.body.appendChild(debugBtn);
            
            console.log("调试按钮添加完成");
        }

        // 立即执行
        //ensureSelectionInitialized();

        // 添加全屏预览功能
        function showFullscreenPreview(imageSrc) {
            // 创建全屏预览容器
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.className = 'fullscreen-preview';
            
            // 创建图片
            const img = document.createElement('img');
            img.src = imageSrc;
            
            // 创建关闭按钮
            const closeBtn = document.createElement('button');
            closeBtn.className = 'fullscreen-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = function() {
                document.body.removeChild(fullscreenDiv);
            };
            
            // 点击背景也可关闭
            fullscreenDiv.onclick = function(e) {
                if (e.target === fullscreenDiv) {
                    document.body.removeChild(fullscreenDiv);
                }
            };
            
            // 组装和显示
            fullscreenDiv.appendChild(img);
            fullscreenDiv.appendChild(closeBtn);
            document.body.appendChild(fullscreenDiv);
        }

        // 修复"Cannot set properties of null (setting 'disabled')"错误
        function fixDisabledPropertyError() {
            console.log("开始修复disabled属性错误...");
            
            // 安全地设置元素属性的辅助函数
            window.safeSetProperty = function(element, property, value) {
                if (!element) {
                    console.warn(`尝试设置属性时元素为null, 属性: ${property}`);
                    return false;
                }
                
                try {
                    element[property] = value;
                    return true;
                } catch (error) {
                    console.error(`设置属性${property}时出错:`, error);
                    return false;
                }
            };
            
            // 通过ID安全设置元素属性
            window.safeSetPropertyById = function(id, property, value) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`未找到ID为${id}的元素，无法设置${property}属性`);
                    return false;
                }
                return safeSetProperty(element, property, value);
            };
                   
            
            // 在文档加载完成后创建按钮
            if (document.readyState === 'complete') {

                updateConvertButtonState();
            } else {
                window.addEventListener('load', function() {

                    updateConvertButtonState();
                });
            }
            
            // 在createScreenshot函数末尾添加状态更新
            const originalCreateScreenshot = window.createScreenshot;
            if (typeof originalCreateScreenshot === 'function') {
                window.createScreenshot = function() {
                    const result = originalCreateScreenshot.apply(this, arguments);

                    updateConvertButtonState();
                    return result;
                };
            }
            
            console.log("disabled属性错误修复完成");
        }

        // 修复updateConvertButtonState函数
        function updateConvertButtonState() {
            try { 
                const convertBtn = document.getElementById('convertBtn');
                if (!convertBtn) {
                    console.warn("未找到转换按钮，跳过状态更新");
                    return;
                }
                
                const screenshots = document.getElementsByClassName('preview-image');
                console.info("screenshots.length:"+screenshots.length);
                if (screenshots.length > 0) {
                    convertBtn.disabled = false;
                    convertBtn.style.opacity = '1';
                    convertBtn.style.cursor = 'pointer';
                    convertBtn.style.display = 'inline-block';
                } else {
                    convertBtn.disabled = true;
                    convertBtn.style.opacity = '0.6';
                    convertBtn.style.cursor = 'not-allowed';
                }
            } catch (error) {
                console.error("更新按钮状态时出错:", error);
            }
        }

        // 立即执行修复
        //fixDisabledPropertyError();

        // 延迟后设置Canvas样式
        setTimeout(function() {
            window.safeSetCanvasStyles();
        }, 2000);
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "PDF to Excel Converter",
      "applicationCategory": "Productivity",
      "operatingSystem": "Web",
      "description": "Free online tool to convert PDF files to Excel spreadsheets by selecting table areas and using OCR.",
      "url": "https://yourdomain.com/pdf2excel.html",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.5",
        "reviewCount": "150"
      }
    }
    </script>
</body>
</html>