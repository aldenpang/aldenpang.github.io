<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Excel Converter - Easily Extract Tables from PDF</title>
    <meta name="description" content="Free online tool to convert PDF files to Excel spreadsheets. Select table areas in your PDF and extract data accurately with OCR technology.">
    <meta name="keywords" content="pdf to excel, convert pdf to excel, pdf table extraction, ocr pdf to excel, pdf data extraction, free pdf converter">
    <link rel="canonical" href="https://yourdomain.com/pdf2excel.html" />
    <meta property="og:title" content="PDF to Excel Converter - Easily Extract Tables from PDF" />
    <meta property="og:description" content="Free online tool to convert PDF files to Excel spreadsheets. Select table areas and extract data accurately." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://yourdomain.com/pdf2excel.html" />
    <meta property="og:image" content="https://yourdomain.com/preview-image.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="PDF to Excel Converter - Easily Extract Tables from PDF" />
    <meta name="twitter:description" content="Free online tool to convert PDF files to Excel spreadsheets. Select table areas and extract data accurately." />
    <meta name="twitter:image" content="https://yourdomain.com/preview-image.png" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3748573797751725"
         crossorigin="anonymous"></script>
    <style>
        .upload-btn {
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .upload-btn:hover {
            background-color: #45a049;
        }
        
        .container {
            margin-top: 50px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: calc(100vh - 50px);
            padding: 20px;
        }

        .pdf-container {
            max-width: 100%;
            overflow: auto;
            position: relative;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            background-color: #f0f0f0;
            margin-bottom: 20px;
            min-height: 500px;
        }
        
        #pdfViewer {
            display: block;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .controls-container {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        /* å¢åŠ ç”»å¸ƒå®¹å™¨å°ºå¯¸ */
        .canvas-container {
            min-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .page-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .page-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .page-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 14px;
            color: #666;
        }

        .selection-box {
            position: absolute;
            border: 2px solid #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
            pointer-events: none;
        }

        .content-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1600px;
            gap: 20px;
            margin-top: 20px;
        }

        .pdf-side {
            flex: 1;
            min-width: 0;
        }

        .preview-side {
            border-left: none;
            border-bottom: 1px solid #ddd;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
        }

        .preview-wrapper {
            position: relative;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding-right: 30px;
        }

        .preview-image {
            display: block;
            width: 300px;
            height: auto;
            border-right: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: contain;
            background-color: white;
        }
        
        .delete-btn {
            position: absolute;
            top: 50%;
            right: 3px;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: red;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ·»åŠ è¯­è¨€é€‰æ‹©å™¨æ ·å¼ */
        .language-selector {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 1001;
        }

        .language-selector select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .language-selector select:hover {
            border-color: #4CAF50;
        }

        #pdfViewerContainer {
            max-width: 100%;
            overflow: auto;
            position: relative;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            background-color: #f0f0f0;
            margin-bottom: 20px;
            min-height: 500px;
        }
        
        #pdfViewer {
            display: block;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        .controls-container {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        /* å¢åŠ ç”»å¸ƒå®¹å™¨å°ºå¯¸ */
        .canvas-container {
            min-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            min-height: 150px;
        }
        
        .preview-wrapper:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .preview-image {
            width: 300px;
            height: auto;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            object-fit: contain;
            background-color: white;
        }
        
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: red;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* æ·»åŠ å…¨å±é¢„è§ˆåŠŸèƒ½ */
        .fullscreen-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .fullscreen-preview img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background: red;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
        }

        .controls-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .action-btn:hover {
            background-color: #0b7dda;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* .convertBtn {
            background-color: #4CAF50;
        }

        .convertBtn:hover:not([disabled]) {
            background-color: #45a049;
        } */
        
        .convert-btn {
            padding: 12px 24px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .convert-btn:hover {
            background-color: #1976D2;
        }
        
        .convert-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .file-input {
            margin-right: 10px;
            cursor: pointer;
        }

        .file-input::-webkit-file-upload-button {
            padding: 6px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .file-input::-webkit-file-upload-button:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="google-ads">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3748573797751725"
        crossorigin="anonymous"></script>
       <!-- pdf2excel -->
       <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-3748573797751725"
           data-ad-slot="7485597563"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
       <script>
           (adsbygoogle = window.adsbygoogle || []).push({});
       </script>
    </div>
    <div class="language-selector">
        <select id="languageSelect" onchange="changeLanguage(this.value)">
            <option value="en">English</option>
            <option value="zh">ä¸­æ–‡</option>
            <option value="fr">FranÃ§ais</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="ko">í•œêµ­ì–´</option>
        </select>
    </div>
    <div class="container">
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="color: #333; font-weight:bold; font-size: 2em; margin-bottom: 10px;">
                PDF to Excel Converter
            </h1>
            <h2 style="color: #666; font-weight: normal; font-size: 1.2em;">
                Steps: 1. Upload PDF â†’ 2. Select Areas â†’ 3. Generate Excel â†’ Done!
            </h2>
        </div>
        <div style="text-align: center;">
            <input type="file" 
                   id="fileInput" 
                   accept=".pdf" 
                   style="display: none">
            <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Upload PDF File
                </button>
                <button id="convertBtn" class="convert-btn" onclick="convertToExcel()" disabled>
                    Convert to Excel
                </button>
            </div>
            <p id="fileInfo" style="margin-top: 10px; color: #666;"></p>
        </div>
        <div class="content-wrapper">
            <div class="preview-side" id="previewContainer">
                <!-- é¢„è§ˆåŒºåŸŸ -->
            </div>
            <div class="pdf-side">
                <div id="pdfViewerContainer" style="position: relative;">
                    <canvas id="pdfViewer" class="pdf-container" style="display: none;"></canvas>
                </div>
                <div class="page-controls" style="display: none;">
                    <button id="prevPage" class="page-btn">Previous</button>
                    <span id="pageInfo" class="page-info">Page 1 of 1</span>
                    <button id="nextPage" class="page-btn">Next</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentPDF = null;
        let currentPage = 1;
        let isSelecting = false;
        let startX, startY;
        let selectionBox = null;

        async function renderPage(pageNum) {
            // ä½¿ç”¨æ­£ç¡®çš„PDFå®¹å™¨ID
            const pdfContainer = document.getElementById('pdfViewerContainer');
            const canvas = document.getElementById('pdfViewer');
            const ctx = canvas.getContext('2d');
            
            // è·å–å½“å‰é¡µ
            const page = await currentPDF.getPage(pageNum);
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿PDFé€‚åº”å®¹å™¨å®½åº¦ä½†ä¿æŒè¾ƒé«˜åˆ†è¾¨ç‡
            const containerWidth = pdfContainer ? pdfContainer.clientWidth : window.innerWidth * 0.8;
            const viewport = page.getViewport({ scale: 1 });
            
            // ä½¿ç”¨æ›´é«˜çš„ç¼©æ”¾å› å­ä»¥æé«˜åˆ†è¾¨ç‡
            const desiredWidth = containerWidth - 20; // ç•™å‡ºä¸€äº›è¾¹è·
            const scale = Math.max(1.5, desiredWidth / viewport.width);
            
            // åˆ›å»ºé«˜åˆ†è¾¨ç‡è§†å£
            const scaledViewport = page.getViewport({ scale: scale });
            
            // è®¾ç½®canvaså°ºå¯¸ä¸ºè§†å£å°ºå¯¸
            canvas.width = scaledViewport.width;
            canvas.height = scaledViewport.height;
            
            // ä½¿ç”¨è®¾å¤‡åƒç´ æ¯”è¿›ä¸€æ­¥æé«˜åˆ†è¾¨ç‡
            const pixelRatio = window.devicePixelRatio || 1;
            canvas.width = scaledViewport.width * pixelRatio;
            canvas.height = scaledViewport.height * pixelRatio;
            
            // è®¾ç½®canvas CSSå°ºå¯¸
            canvas.style.width = `${scaledViewport.width}px`;
            canvas.style.height = `${scaledViewport.height}px`;
            
            // ç¼©æ”¾ç»˜å›¾ä¸Šä¸‹æ–‡ä»¥åŒ¹é…è®¾å¤‡åƒç´ æ¯”
            ctx.scale(pixelRatio, pixelRatio);
            
            // æ¸²æŸ“PDFé¡µé¢
            const renderContext = {
                canvasContext: ctx,
                viewport: scaledViewport,
                enableWebGL: true,
                renderInteractiveForms: true
            };
            
            try {
                await page.render(renderContext).promise;
                
                // æ›´æ–°å½“å‰é¡µç æ˜¾ç¤º
                document.getElementById('pageInfo').textContent = `Page ${pageNum} of ${currentPDF.numPages}`;
                document.getElementById('prevPage').disabled = pageNum <= 1;
                document.getElementById('nextPage').disabled = pageNum >= currentPDF.numPages;
                currentPage = pageNum;
                
                // æ˜¾ç¤ºPDFæŸ¥çœ‹å™¨
                document.getElementById('pdfViewerContainer').style.display = 'block';
                canvas.style.display = 'block';
            } catch (error) {
                console.error('Error rendering PDF page:', error);
            }
        }

        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileInfo').textContent = `Selected file: ${file.name}`;
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const typedarray = new Uint8Array(arrayBuffer);
                    
                    console.log('Starting PDF loading...');
                    currentPDF = await pdfjsLib.getDocument({data: typedarray}).promise;
                    console.log('PDF loaded successfully, pages:', currentPDF.numPages);
                    
                    currentPage = 1;
                    
                    document.getElementById('pdfViewer').style.display = 'block';
                    document.getElementById('pdfViewerContainer').style.display = 'block';
                    document.querySelector('.page-controls').style.display = 'flex';
                    
                    await renderPage(currentPage);
                } catch (error) {
                    console.error('PDF loading error:', error);
                    alert('Failed to load PDF: ' + error.message);
                }
            }
        });

        document.getElementById('prevPage').addEventListener('click', async () => {
            if (currentPage > 1) {
                currentPage--;
                await renderPage(currentPage);
            }
        });

        document.getElementById('nextPage').addEventListener('click', async () => {
            if (currentPDF && currentPage < currentPDF.numPages) {
                currentPage++;
                await renderPage(currentPage);
            }
        });

        function initializeSelection() {
            console.log("åˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½...");
            const canvas = document.getElementById('pdfViewer');
            const pdfContainer = document.getElementById('pdfViewerContainer');
            
            // ç¡®ä¿é¢„è§ˆå®¹å™¨å­˜åœ¨
            let previewContainer = document.getElementById('previewContainer');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'previewContainer';
                previewContainer.className = 'preview-container';
                document.querySelector('.pdf-tools').appendChild(previewContainer);
            }
            
            // é¼ æ ‡æŒ‰ä¸‹æ—¶å¼€å§‹é€‰æ‹©
            canvas.addEventListener('mousedown', function(e) {
                console.log("é¼ æ ‡æŒ‰ä¸‹", e);
                const rect = canvas.getBoundingClientRect();
                startX = (e.clientX - rect.left) * (canvas.width / rect.width);
                startY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                isSelecting = true;
                
                // åˆ›å»ºé€‰æ‹©æ¡†
                if (selectionBox) {
                    selectionBox.remove();
                }
                
                selectionBox = document.createElement('div');
                selectionBox.className = 'selection-box';
                selectionBox.style.position = 'absolute';
                selectionBox.style.border = '2px dashed red';
                selectionBox.style.backgroundColor = 'rgba(255, 0, 0, 0.1)';
                selectionBox.style.pointerEvents = 'none';
                pdfContainer.appendChild(selectionBox);
            });
            
            // é¼ æ ‡ç§»åŠ¨æ—¶æ›´æ–°é€‰æ‹©æ¡†
            canvas.addEventListener('mousemove', function(e) {
                if (!isSelecting || !selectionBox) return;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                const canvasLeft = canvas.offsetLeft;
                const canvasTop = canvas.offsetTop;
                
                const left = Math.min(startX, currentX * (canvas.width / rect.width)) / (canvas.width / rect.width) + canvasLeft;
                const top = Math.min(startY, currentY * (canvas.height / rect.height)) / (canvas.height / rect.height) + canvasTop;
                const width = Math.abs(currentX * (canvas.width / rect.width) - startX) / (canvas.width / rect.width);
                const height = Math.abs(currentY * (canvas.height / rect.height) - startY) / (canvas.height / rect.height);
                
                selectionBox.style.left = left + 'px';
                selectionBox.style.top = top + 'px';
                selectionBox.style.width = width + 'px';
                selectionBox.style.height = height + 'px';
            });
            
            // é¼ æ ‡æ¾å¼€æ—¶å®Œæˆé€‰æ‹©
            canvas.addEventListener('mouseup', function(e) {
                if (!isSelecting || !selectionBox) return;
                
                isSelecting = false;
                
                const rect = canvas.getBoundingClientRect();
                const currentX = (e.clientX - rect.left) * (canvas.width / rect.width);
                const currentY = (e.clientY - rect.top) * (canvas.height / rect.height);
                
                // è®¡ç®—é€‰æ‹©åŒºåŸŸ
                const x = Math.min(startX, currentX);
                const y = Math.min(startY, currentY);
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);
                
                // éªŒè¯é€‰æ‹©åŒºåŸŸå¤§å°
                if (width < 10 || height < 10) {
                    if (selectionBox && selectionBox.parentNode) {
                        selectionBox.parentNode.removeChild(selectionBox);
                    }
                    selectionBox = null;
                    return;
                }
                
                // åˆ›å»ºå¹¶æ·»åŠ æˆªå›¾
                const previewWrapper = createScreenshot(canvas, x, y, width, height);
                
                // æ·»åŠ åˆ°é¢„è§ˆå®¹å™¨
                const previewContainer = document.getElementById('previewContainer');
                if (previewContainer) {
                    previewContainer.appendChild(previewWrapper);
                }
                
                // æ˜¾ç¤ºè½¬æ¢æŒ‰é’®
                const convertBtn = document.getElementById('convertBtn');
                if (convertBtn) {
                    convertBtn.style.display = 'block';
                    convertBtn.disabled = false;
                }
                else{
                    console.log("è½¬æ¢æŒ‰é’®ä¸å­˜åœ¨");
                }
                
                // æ¸…ç†é€‰æ‹©æ¡† - ç¡®ä¿ç§»é™¤é€‰æ‹©æ¡†
                if (selectionBox && selectionBox.parentNode) {
                    selectionBox.parentNode.removeChild(selectionBox);
                }
                selectionBox = null;
                
                console.log("é€‰æ¡†å·²å–æ¶ˆï¼Œæˆªå›¾å·²æ·»åŠ åˆ°é¢„è§ˆåŒºåŸŸ");
            });
            
            // æ¸…ç†
            canvas.addEventListener('mouseleave', function() {
                if (isSelecting && selectionBox) {
                    isSelecting = false;
                    selectionBox.remove();
                    selectionBox = null;
                }
            });
        }

        // æ·»åŠ è¯­è¨€ç¿»è¯‘é…ç½®
        const translations = {
            en: {
                steps: "Steps: 1. Upload PDF â†’ 2. Select Areas â†’ 3. Generate Excel â†’ Done!",
                uploadBtn: "Upload PDF File",
                prevPage: "Previous",
                nextPage: "Next",
                pageInfo: "Page {current} of {total}",
                deleteBtn: "Delete",
                adBanner: "ğŸ”¥ Special Offer: Online PDF Processing Tool - Click to Learn More",
                convertBtn: "Convert to CSV",
                featureInDev: "This feature is coming soon! We're working hard to bring you table recognition and Excel conversion.",
                processing: "Processing...",
                processingProgress: "Processing {current}/{total}..."
            },
            zh: {
                steps: "æ­¥éª¤ï¼š1. ä¸Šä¼ PDF â†’ 2. é€‰æ‹©åŒºåŸŸ â†’ 3. ç”ŸæˆExcelè¡¨æ ¼ â†’ å®Œæˆï¼",
                uploadBtn: "ä¸Šä¼ PDFæ–‡ä»¶",
                prevPage: "ä¸Šä¸€é¡µ",
                nextPage: "ä¸‹ä¸€é¡µ",
                pageInfo: "ç¬¬ {current} é¡µï¼Œå…± {total} é¡µ",
                deleteBtn: "åˆ é™¤",
                adBanner: "ğŸ”¥ ç‰¹æƒ ï¼šåœ¨çº¿PDFå¤„ç†å·¥å…· - ç‚¹å‡»äº†è§£æ›´å¤š",
                convertBtn: "è½¬æ¢ä¸ºCSV",
                featureInDev: "æ­¤åŠŸèƒ½å³å°†æ¨å‡ºï¼æˆ‘ä»¬æ­£åœ¨åŠªåŠ›å¼€å‘è¡¨æ ¼è¯†åˆ«å’ŒExcelè½¬æ¢åŠŸèƒ½ã€‚",
                processing: "å¤„ç†ä¸­...",
                processingProgress: "æ­£åœ¨å¤„ç† {current}/{total}..."
            },
            fr: {
                steps: "Ã‰tapes : 1. TÃ©lÃ©charger PDF â†’ 2. SÃ©lectionner zones â†’ 3. GÃ©nÃ©rer Excel â†’ TerminÃ© !",
                uploadBtn: "TÃ©lÃ©charger PDF",
                prevPage: "PrÃ©cÃ©dent",
                nextPage: "Suivant",
                pageInfo: "Page {current} sur {total}",
                deleteBtn: "Supprimer",
                adBanner: "ğŸ”¥ Offre SpÃ©ciale : Outil de traitement PDF en ligne - Cliquez pour en savoir plus",
                convertBtn: "Convertir en CSV",
                featureInDev: "Cette fonctionnalitÃ© sera bientÃ´t disponible ! Nous travaillons sur la reconnaissance de tableaux et la conversion Excel.",
                processing: "En cours de traitement...",
                processingProgress: "Traitement {current}/{total}..."
            },
            ja: {
                steps: "æ‰‹é †ï¼š1. PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â†’ 2. é ˜åŸŸã‚’é¸æŠ â†’ 3. Excelã‚’ç”Ÿæˆ â†’ å®Œäº†ï¼",
                uploadBtn: "PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
                prevPage: "å‰ã¸",
                nextPage: "æ¬¡ã¸",
                pageInfo: "ãƒšãƒ¼ã‚¸ {current}/{total}",
                deleteBtn: "å‰Šé™¤",
                adBanner: "ğŸ”¥ ç‰¹åˆ¥ã‚ªãƒ•ã‚¡ãƒ¼ï¼šã‚ªãƒ³ãƒ©ã‚¤ãƒ³PDFå‡¦ç†ãƒ„ãƒ¼ãƒ« - è©³ç´°ã¯ã“ã¡ã‚‰",
                convertBtn: "CSVã«å¤‰æ›",
                featureInDev: "ã“ã®æ©Ÿèƒ½ã¯è¿‘æ—¥å…¬é–‹äºˆå®šã§ã™ï¼è¡¨ã®èªè­˜ã¨Excelå¤‰æ›æ©Ÿèƒ½ã‚’é–‹ç™ºä¸­ã§ã™ã€‚",
                processing: "å‡¦ç†ä¸­...",
                processingProgress: "å‡¦ç†ä¸­ {current}/{total}..."
            },
            ko: {
                steps: "ë‹¨ê³„: 1. PDF ì—…ë¡œë“œ â†’ 2. ì˜ì—­ ì„ íƒ â†’ 3. Excel ìƒì„± â†’ ì™„ë£Œ!",
                uploadBtn: "PDF ì—…ë¡œë“œ",
                prevPage: "ì´ì „",
                nextPage: "ë‹¤ìŒ",
                pageInfo: "í˜ì´ì§€ {current}/{total}",
                deleteBtn: "ì‚­ì œ",
                adBanner: "ğŸ”¥ íŠ¹ë³„ ì œê³µ: ì˜¨ë¼ì¸ PDF ì²˜ë¦¬ ë„êµ¬ - ìì„¸íˆ ì•Œì•„ë³´ê¸°",
                convertBtn: "CSVë¡œ ë³€í™˜",
                featureInDev: "ì´ ê¸°ëŠ¥ì€ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤! í‘œ ì¸ì‹ ë° Excel ë³€í™˜ ê¸°ëŠ¥ì„ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.",
                processing: "ì²˜ë¦¬ì¤‘...",
                processingProgress: "ì²˜ë¦¬ì¤‘ {current}/{total}..."
            }
        };

        // æ·»åŠ è¯­è¨€åˆ‡æ¢å‡½æ•°
        function changeLanguage(lang) {
            const t = translations[lang];
            
            // æ›´æ–°æ­¥éª¤è¯´æ˜
            document.querySelector('h2').textContent = t.steps;
            
            // æ›´æ–°ä¸Šä¼ æŒ‰é’®
            document.querySelector('.upload-btn').textContent = t.uploadBtn;
            
            // æ›´æ–°é¡µé¢æ§åˆ¶æŒ‰é’®
            document.getElementById('prevPage').textContent = t.prevPage;
            document.getElementById('nextPage').textContent = t.nextPage;
            
            // æ›´æ–°é¡µç ä¿¡æ¯
            const currentPageInfo = document.getElementById('pageInfo').textContent;
            const matches = currentPageInfo.match(/\d+/g);
            if (matches && matches.length === 2) {
                document.getElementById('pageInfo').textContent = 
                    t.pageInfo.replace('{current}', matches[0]).replace('{total}', matches[1]);
            }
            
            // æ›´æ–°å¹¿å‘Šæ¨ªå¹…
            document.querySelector('.ad-banner a').textContent = t.adBanner;
            
            // æ›´æ–°æ‰€æœ‰åˆ é™¤æŒ‰é’®
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.textContent = t.deleteBtn;
            });
            
            // æ›´æ–°è½¬æ¢æŒ‰é’®
            document.getElementById('convertBtn').textContent = t.convertBtn;
        }

        // ä¿®æ”¹ç”Ÿæˆæ–‡ä»¶çš„å‡½æ•°ï¼Œä»Excelæ”¹ä¸ºCSV
        function generateCsvFile(allTableData) {
            // å°†æ‰€æœ‰è¡¨æ ¼æ•°æ®åˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œè¡¨æ ¼ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”
            const mergedData = allTableData.reduce((acc, table, tableIndex) => {
                if (tableIndex > 0) acc.push([]); // æ·»åŠ ç©ºè¡Œåˆ†éš”ä¸åŒè¡¨æ ¼
                return acc.concat(table);
            }, []);
            
            // è½¬æ¢ä¸ºCSVæ ¼å¼
            const csvContent = mergedData.map(row => {
                return row.map(cell => {
                    // å¤„ç†é€—å·ã€æ¢è¡Œç¬¦å’Œå¼•å·ç­‰ç‰¹æ®Šå­—ç¬¦
                    const cellStr = String(cell || '');
                    if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(',');
            }).join('\n');
            
            // æ·»åŠ UTF-8 BOMæ ‡è®°ï¼Œç¡®ä¿Excelæ­£ç¡®è¯†åˆ«ä¸­æ–‡
            const bomPrefix = '\uFEFF';
            
            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob([bomPrefix + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'table_data.csv';
            
            // æ·»åŠ åˆ°æ–‡æ¡£å¹¶è§¦å‘ç‚¹å‡»
            document.body.appendChild(a);
            a.click();
            
            // æ¸…ç†
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }

        // ä¿®æ”¹å›¾åƒå¤„ç†å‡½æ•°ä»¥ç”Ÿæˆæ­£ç¡®çš„base64æ ¼å¼
        async function prepareImageForAPI(imgSrc) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ä½¿ç”¨DeepSeekæ¨èå°ºå¯¸
                        const maxSize = 512; 
                        let width = img.width;
                        let height = img.height;
                        
                        // è®¡ç®—æ–°å°ºå¯¸ï¼Œä¿æŒå®½é«˜æ¯”
                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round(height * (maxSize / width));
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round(width * (maxSize / height));
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ç»˜åˆ¶ç™½è‰²èƒŒæ™¯
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, width, height);
                        
                        // ç»˜åˆ¶å›¾åƒ
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ç”Ÿæˆbase64 URLæ ¼å¼
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl); // è¿”å›å®Œæ•´çš„data URL
                    } catch (error) {
                        reject(error);
                    }
                };
                img.onerror = reject;
                img.src = imgSrc;
            });
        }

        // ä¿®æ”¹convertToExcelå‡½æ•°ï¼Œå®Œå…¨åˆ é™¤çŠ¶æ€æ˜¾ç¤º
        async function convertToExcel() {
            const previewContainer = document.getElementById('previewContainer');
            const screenshots = previewContainer.getElementsByClassName('preview-image');
            
            if (screenshots.length === 0) {
                alert(translations[document.getElementById('languageSelect').value].noScreenshots || 'è¯·å…ˆä»PDFä¸­é€‰æ‹©åŒºåŸŸ');
                return;
            }
            else
            {
                console.info('é€‰ä¸­æˆªå›¾ä¸ªæ•°ï¼š'+screenshots.length);
            }

            try {
                const convertBtn = document.getElementById('convertBtn');
                const originalText = convertBtn.textContent;
                convertBtn.disabled = true;
                convertBtn.textContent = translations[document.getElementById('languageSelect').value].processing;

                // ç›´æ¥åŠ è½½OCRå¼•æ“ï¼Œä¸æ˜¾ç¤ºçŠ¶æ€
                let worker;
                try {
                    worker = await Tesseract.createWorker({
                        logger: m => {
                            console.log(m);
                        }
                    });
                    
                    // é…ç½®OCR
                    await worker.loadLanguage('eng+chi_sim');
                    await worker.initialize('eng+chi_sim');
                    await worker.setParameters({
                        tessedit_char_whitelist: '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.,-+/*()%:;?!@#$&=<>[]{}_\\|~"\'',
                        preserve_interword_spaces: '1'
                    });
                } catch (error) {
                    console.error('OCRå¼•æ“åˆå§‹åŒ–å¤±è´¥:', error);
                    convertBtn.disabled = false;
                    convertBtn.textContent = originalText;
                    alert('OCRå¼•æ“åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                    return;
                }

                let allTableData = [];
                
                // å¤„ç†æ¯ä¸ªæˆªå›¾
                for (let i = 0; i < screenshots.length; i++) {
                    const img = screenshots[i];
                    
                    console.log(`å¤„ç†å›¾ç‰‡ ${i+1}/${screenshots.length}...`);
                    
                    try {
                        // ä½¿ç”¨OCRè¯†åˆ«å›¾ç‰‡
                        const { data } = await worker.recognize(img.src);
                        
                        // å¤„ç†OCRç»“æœä¸ºè¡¨æ ¼æ•°æ®
                        const tableData = extractTableFromOCR(data);
                        
                        if (tableData.length > 0) {
                            allTableData.push(tableData);
                            console.log(`å›¾ç‰‡ ${i+1}/${screenshots.length} å¤„ç†å®Œæˆï¼Œè¯†åˆ«åˆ° ${tableData.length} è¡Œæ•°æ®`);
                        } else {
                            console.log(`å›¾ç‰‡ ${i+1}/${screenshots.length} æœªè¯†åˆ«åˆ°è¡¨æ ¼æ•°æ®`);
                            allTableData.push([['æ— æ³•è¯†åˆ«è¡¨æ ¼æ•°æ®']]);
                        }
                    } catch (error) {
                        console.error(`å¤„ç†å›¾ç‰‡ ${i+1} å¤±è´¥:`, error);
                        
                        allTableData.push([
                            [`å›¾ç‰‡ ${i+1} å¤„ç†å¤±è´¥`],
                            ['é”™è¯¯ä¿¡æ¯: ' + error.message],
                            ['è¯·æ‰‹åŠ¨æŸ¥çœ‹åŸå§‹PDFå¹¶å½•å…¥æ•°æ®']
                        ]);
                    }
                }
                
                // ç»ˆæ­¢OCRå·¥ä½œå™¨
                await worker.terminate();
                
                if (allTableData.length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°æœ‰æ•ˆè¡¨æ ¼æ•°æ®');
                }
                
                // ç”ŸæˆCSV
                console.log('ç”ŸæˆCSVæ–‡ä»¶...');
                generateCsvFile(allTableData);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                convertBtn.disabled = false;
                convertBtn.textContent = originalText;
                
            } catch (error) {
                console.error('è½¬æ¢é”™è¯¯:', error);
                alert('è½¬æ¢å¤±è´¥: ' + error.message);
                
                const convertBtn = document.getElementById('convertBtn');
                convertBtn.disabled = false;
                convertBtn.textContent = translations[document.getElementById('languageSelect').value].convertBtn;
            }
        }

        // æ·»åŠ è¡¨æ ¼æå–å‡½æ•°
        function extractTableFromOCR(ocrData) {
            const lines = ocrData.text.split('\n').filter(line => line.trim() !== '');
            
            // åˆ›å»ºè¡¨æ ¼æ•°æ®
            const tableData = [];
            
            // è¯†åˆ«è¡¨æ ¼ç»“æ„
            for (const line of lines) {
                // å°è¯•æ‹†åˆ†è¡Œå†…æ•°æ®ä¸ºå•å…ƒæ ¼
                let cells;
                
                if (line.includes('|')) {
                    // å¦‚æœæœ‰|åˆ†éš”ç¬¦ï¼ŒæŒ‰|åˆ†éš”
                    cells = line.split('|').map(cell => cell.trim());
                } else if (line.includes('\t')) {
                    // å¦‚æœæœ‰åˆ¶è¡¨ç¬¦ï¼ŒæŒ‰åˆ¶è¡¨ç¬¦åˆ†éš”
                    cells = line.split('\t').map(cell => cell.trim());
                } else {
                    // å°è¯•æŒ‰å¤šä¸ªç©ºæ ¼åˆ†éš”ï¼ˆ2ä¸ªä»¥ä¸Šç©ºæ ¼ï¼‰
                    cells = line.split(/\s{2,}/).map(cell => cell.trim()).filter(cell => cell !== '');
                    
                    // å¦‚æœåˆ†å‰²ååªæœ‰ä¸€ä¸ªå•å…ƒæ ¼ï¼Œå°è¯•åŸºäºä½ç½®ä¿¡æ¯æ‹†åˆ†
                    if (cells.length <= 1 && ocrData.words) {
                        cells = splitLineByPositions(line, ocrData.words);
                    }
                }
                
                // å¦‚æœä»ç„¶åªæœ‰ä¸€ä¸ªå•å…ƒæ ¼ï¼Œåˆ™ä¿æŒåŸæ ·
                if (cells.length <= 1) {
                    cells = [line.trim()];
                }
                
                // å¤„ç†æ¯ä¸ªå•å…ƒæ ¼ï¼ŒæŸ¥æ‰¾æ—¥æœŸ
                const processedCells = [];
                const foundDates = [];
                
                for (const cell of cells) {
                    // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦åŒ…å«æ—¥æœŸ
                    const dateInfo = extractDateFromText(cell);
                    
                    if (dateInfo.hasDate) {
                        // å¦‚æœåŒ…å«æ—¥æœŸï¼Œæ·»åŠ åŸå§‹å•å…ƒæ ¼å†…å®¹å’Œæå–å‡ºçš„æ—¥æœŸ
                        processedCells.push(dateInfo.textWithoutDate);
                        foundDates.push(dateInfo.date);
                    } else {
                        // æ²¡æœ‰æ—¥æœŸï¼Œä¿æŒåŸæ ·
                        processedCells.push(cell);
                    }
                }
                
                // æ·»åŠ æ—¥æœŸåˆ—ï¼ˆå¦‚æœæœ‰ï¼‰
                const rowData = [...processedCells];
                if (foundDates.length > 0) {
                    // æ·»åŠ æ‰€æœ‰æ‰¾åˆ°çš„æ—¥æœŸä½œä¸ºå•ç‹¬çš„åˆ—
                    rowData.push(...foundDates);
                }
                
                // æ·»åŠ åˆ°è¡¨æ ¼æ•°æ®
                tableData.push(rowData);
            }
            
            return tableData;
        }

        // ä¿®æ­£ä»æ–‡æœ¬ä¸­æå–æ—¥æœŸçš„å‡½æ•°ï¼Œç¡®ä¿æ­£ç¡®è¯†åˆ«JUL18æ ¼å¼
        function extractDateFromText(text) {
            const result = {
                hasDate: false,
                date: '',
                textWithoutDate: text
            };
            
            // æœˆä»½åç§°æ˜ å°„
            const monthMap = {
                'JAN': '01', 'FEB': '02', 'MAR': '03', 'APR': '04', 
                'MAY': '05', 'JUN': '06', 'JUL': '07', 'AUG': '08', 
                'SEP': '09', 'OCT': '10', 'NOV': '11', 'DEC': '12'
            };
            
            // å¸¸è§æ—¥æœŸæ ¼å¼çš„æ­£åˆ™è¡¨è¾¾å¼
            const datePatterns = [
                // ç‰¹åˆ«å¤„ç†JUL18è¿™ç§ç´§å‡‘æ ¼å¼ï¼Œæ”¾åœ¨ç¬¬ä¸€ä½
                {
                    regex: /(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(\d{1,2})/gi,
                    format: (month, day) => {
                        const year = new Date().getFullYear();
                        const monthNum = monthMap[month.toUpperCase()];
                        return `${year}-${monthNum}-${day.padStart(2, '0')}`;
                    }
                },
                // å…¶ä»–çš„è‹±æ–‡æœˆä»½æ ¼å¼
                {
                    regex: /\b(JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)\s+(\d{1,2})\b/gi,
                    format: (month, day) => {
                        const year = new Date().getFullYear();
                        const monthNum = monthMap[month.toUpperCase()];
                        return `${year}-${monthNum}-${day.padStart(2, '0')}`;
                    }
                },
                // ä¿ç•™åŸæœ‰çš„æ—¥æœŸæ ¼å¼
                {
                    regex: /\b(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})\b/g,
                    format: (y, m, d) => `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`
                },
                {
                    regex: /\b(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})\b/g,
                    format: (d, m, y) => `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`
                },
                {
                    regex: /\b(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥\b/g,
                    format: (y, m, d) => `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`
                },
                {
                    regex: /\b(\d{1,2})æœˆ(\d{1,2})æ—¥\b/g,
                    format: (m, d) => {
                        const year = new Date().getFullYear();
                        return `${year}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
                    }
                }
            ];
            
            // æ·»åŠ è°ƒè¯•è¾“å‡º
            console.log("æ£€æŸ¥æ—¥æœŸæ–‡æœ¬:", text);
            
            let modifiedText = text;
            
            // æ£€æŸ¥æ‰€æœ‰æ—¥æœŸæ¨¡å¼
            for (const pattern of datePatterns) {
                const matches = [...text.matchAll(pattern.regex)];
                console.log("æ¨¡å¼åŒ¹é…ç»“æœ:", pattern.regex, matches.length > 0 ? matches : "æ— åŒ¹é…");
                
                if (matches.length > 0) {
                    for (const match of matches) {
                        // æå–æ—¥æœŸéƒ¨åˆ†
                        const matchedText = match[0];
                        console.log("åŒ¹é…åˆ°æ—¥æœŸ:", matchedText, match);
                        
                        // åº”ç”¨æ ¼å¼åŒ–
                        if (match.length === 4) { // ä¸‰éƒ¨åˆ†æ—¥æœŸ
                            result.date = pattern.format(match[1], match[2], match[3]);
                        } else if (match.length === 3) { // ä¸¤éƒ¨åˆ†æ—¥æœŸ
                            result.date = pattern.format(match[1], match[2]);
                        }
                        
                        // ä»æ–‡æœ¬ä¸­ç§»é™¤æ—¥æœŸ
                        modifiedText = modifiedText.replace(matchedText, '').trim();
                        
                        // åªå¤„ç†æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæ—¥æœŸ
                        result.hasDate = true;
                        result.textWithoutDate = modifiedText;
                        console.log("å¤„ç†åç»“æœ:", result);
                        break;
                    }
                    
                    // å¦‚æœæ‰¾åˆ°äº†æ—¥æœŸï¼Œå°±ä¸å†æ£€æŸ¥å…¶ä»–æ¨¡å¼
                    if (result.hasDate) break;
                }
            }
            
            return result;
        }

        // åŸºäºä½ç½®ä¿¡æ¯æ‹†åˆ†è¡Œ
        function splitLineByPositions(line, words) {
            // æ‰¾åˆ°å±äºè¿™ä¸€è¡Œçš„æ‰€æœ‰words
            const lineWords = words.filter(word => 
                line.includes(word.text) && 
                word.text.trim() !== ''
            );
            
            // æŒ‰ç…§xåæ ‡æ’åº
            lineWords.sort((a, b) => a.bbox.x0 - b.bbox.x0);
            
            // æ£€æµ‹é—´éš”ï¼Œæ‰¾å‡ºå¯èƒ½çš„åˆ—è¾¹ç•Œ
            const gaps = [];
            for (let i = 1; i < lineWords.length; i++) {
                const gap = lineWords[i].bbox.x0 - lineWords[i-1].bbox.x1;
                gaps.push({
                    index: i,
                    size: gap
                });
            }
            
            // æŒ‰é—´éš”å¤§å°æ’åº
            gaps.sort((a, b) => b.size - a.size);
            
            // å–æœ€å¤§çš„å‡ ä¸ªé—´éš”ä½œä¸ºåˆ—åˆ†éš”ç‚¹ï¼ˆæ ¹æ®æ•°æ®å¤æ‚åº¦å¯è°ƒæ•´æ•°é‡ï¼‰
            const columnBreaks = gaps.slice(0, Math.min(4, Math.floor(gaps.length / 2)))
                .sort((a, b) => a.index - b.index)
                .map(g => g.index);
            
            // æ ¹æ®åˆ†éš”ç‚¹å°†è¯ç»„åˆä¸ºå•å…ƒæ ¼
            const cells = [];
            let currentCell = [];
            
            for (let i = 0; i < lineWords.length; i++) {
                currentCell.push(lineWords[i].text);
                
                if (columnBreaks.includes(i+1) || i === lineWords.length - 1) {
                    cells.push(currentCell.join(' '));
                    currentCell = [];
                }
            }
            
            return cells;
        }

        // ä¿®æ”¹createScreenshotå‡½æ•°ï¼Œç¡®ä¿è½¬æ¢æŒ‰é’®æ˜¾ç¤º
        function createScreenshot(canvas, x, y, width, height) {
            // åˆ›å»ºæˆªå›¾
            const screenshotCanvas = document.createElement('canvas');
            const ctx = screenshotCanvas.getContext('2d');
            
            // è®¾ç½®æ›´é«˜åˆ†è¾¨ç‡
            const scaleFactor = 3; // å¢åŠ åˆ°3å€åˆ†è¾¨ç‡
            screenshotCanvas.width = width * scaleFactor;
            screenshotCanvas.height = height * scaleFactor;
            
            // å¯ç”¨é«˜è´¨é‡å›¾åƒæ¸²æŸ“
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // ç»˜åˆ¶é€‰ä¸­åŒºåŸŸ
            ctx.drawImage(
                canvas, 
                x, y, width, height,
                0, 0, screenshotCanvas.width, screenshotCanvas.height
            );
            
            // åˆ›å»ºé¢„è§ˆå›¾ç‰‡
            const previewImg = new Image();
            previewImg.className = 'preview-image';
            previewImg.src = screenshotCanvas.toDataURL('image/png');
            
            // è®©å›¾ç‰‡å¯ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
            previewImg.onclick = function() {
                showFullscreenPreview(this.src);
            };
            
            // åˆ›å»ºåˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.className = 'delete-btn';
            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                previewWrapper.remove();
                updateConvertButtonState();
            };
            
            // åˆ›å»ºé¢„è§ˆåŒ…è£…å®¹å™¨
            const previewWrapper = document.createElement('div');
            previewWrapper.className = 'preview-wrapper';
            previewWrapper.appendChild(previewImg);
            previewWrapper.appendChild(deleteBtn);
            
            // æ·»åŠ åˆ°æœ«å°¾
            updateConvertButtonState();
            return previewWrapper;
        }

        // åˆå§‹åŒ–å‡½æ•°ï¼Œç¡®ä¿é¡µé¢ä¸­æœ‰é¢„è§ˆå®¹å™¨å’ŒæŒ‰é’®åŒºåŸŸ
        function initializeUI() {
            // ç¡®ä¿é¢„è§ˆå®¹å™¨å­˜åœ¨
            let previewContainer = document.getElementById('previewContainer');
            if (!previewContainer) {
                previewContainer = document.createElement('div');
                previewContainer.id = 'previewContainer';
                previewContainer.className = 'preview-container';
                
                // æŸ¥æ‰¾PDFå·¥å…·åŒºåŸŸå¹¶æ·»åŠ 
                const pdfTools = document.querySelector('.pdf-tools');
                if (pdfTools) {
                    pdfTools.appendChild(previewContainer);
                } else {
                    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œæ·»åŠ åˆ°body
                    document.body.appendChild(previewContainer);
                }
            }
            
            // åˆ›å»ºè½¬æ¢æŒ‰é’®ï¼Œä½†é»˜è®¤éšè—
            const convertBtn = document.getElementById('convertBtn');
            convertBtn.style.display = 'none';
        }

        // å¼ºåˆ¶åˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½
        (function forceInitialize() {
            console.log("å¼€å§‹å¼ºåˆ¶åˆå§‹åŒ–...");
            
            // ç›´æ¥è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
            setTimeout(function() {
                console.log("æ­£åœ¨è°ƒç”¨initializeSelection...");
                if (typeof initializeSelection === 'function') {
                    initializeSelection();
                    console.log("initializeSelectionå‡½æ•°å·²è°ƒç”¨");
                } else {
                    console.error("initializeSelectionå‡½æ•°ä¸å­˜åœ¨ï¼");
                }
            }, 2000);
            
            // ä¿®æ”¹PDFåŠ è½½å‡½æ•°ï¼Œç¡®ä¿åœ¨åŠ è½½PDFæ—¶ä¹Ÿåˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½
            const originalLoadPDF = window.loadPDF;
            if (typeof originalLoadPDF === 'function') {
                window.loadPDF = function(file) {
                    console.log("æ‹¦æˆªåˆ°PDFåŠ è½½ï¼Œå°†åœ¨åŠ è½½ååˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½");
                    const result = originalLoadPDF.call(this, file);
                    
                    // åœ¨PDFåŠ è½½åï¼Œç¡®ä¿åˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½
                    setTimeout(function() {
                        console.log("PDFå·²åŠ è½½ï¼Œåˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½");
                        initializeSelection();
                    }, 1000);
                    
                    return result;
                };
            }
            
            // ç›‘å¬PDFæ¸²æŸ“å®Œæˆäº‹ä»¶
            document.addEventListener('pdfrendered', function() {
                console.log("æ£€æµ‹åˆ°PDFæ¸²æŸ“å®Œæˆäº‹ä»¶ï¼Œåˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½");
                setTimeout(initializeSelection, 500);
            });
            
            // è½®è¯¢æ£€æŸ¥PDFæ˜¯å¦å·²ç»åŠ è½½
            const checkPDFLoaded = function() {
                const canvas = document.getElementById('pdfViewer');
                if (canvas) {
                    console.log("å‘ç°PDFç”»å¸ƒï¼Œåˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½");
                    initializeSelection();
                } else {
                    console.log("æœªæ‰¾åˆ°PDFç”»å¸ƒï¼Œç»§ç»­ç­‰å¾…...");
                    setTimeout(checkPDFLoaded, 1000);
                }
            };
            
            // å¼€å§‹è½®è¯¢
            setTimeout(checkPDFLoaded, 1000);
            
            // æ·»åŠ ç›´æ¥è°ƒç”¨å‡½æ•°åˆ°windowå¯¹è±¡
            window.forceInitializeSelection = function() {
                console.log("æ‰‹åŠ¨è§¦å‘åˆå§‹åŒ–");
                initializeSelection();
            };
            
            console.log("å¼ºåˆ¶åˆå§‹åŒ–è®¾ç½®å®Œæˆ");
        })();

        // ç¡®ä¿é€‰æ‹©åŠŸèƒ½è¢«åˆå§‹åŒ–ï¼Œä¿®å¤äº‹ä»¶ç›‘å¬é€»è¾‘
        function ensureSelectionInitialized() {
            console.log("ç¡®ä¿é€‰æ‹©åŠŸèƒ½è¢«åˆå§‹åŒ–...");
            
            // å°†initializeSelectionæ·»åŠ åˆ°å…¨å±€å¯¹è±¡ï¼Œæ–¹ä¾¿è°ƒè¯•
            window.initializeSelection = initializeSelection;
            
            // æ˜¾ç¤ºè°ƒè¯•æŒ‰é’®
            const debugBtn = document.createElement('button');
            debugBtn.textContent = "åˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½";
            debugBtn.style.position = "fixed";
            debugBtn.style.top = "10px";
            debugBtn.style.right = "10px";
            debugBtn.style.zIndex = "9999";
            debugBtn.style.padding = "5px 10px";
            debugBtn.style.backgroundColor = "#ff9800";
            debugBtn.style.color = "white";
            debugBtn.style.border = "none";
            debugBtn.style.borderRadius = "4px";
            debugBtn.style.cursor = "pointer";
            
            debugBtn.addEventListener('click', function() {
                console.log("æ‰‹åŠ¨ç‚¹å‡»åˆå§‹åŒ–é€‰æ‹©åŠŸèƒ½");
                initializeSelection();
            });
            
            document.body.appendChild(debugBtn);
            
            console.log("è°ƒè¯•æŒ‰é’®æ·»åŠ å®Œæˆ");
        }

        // ç«‹å³æ‰§è¡Œ
        //ensureSelectionInitialized();

        // æ·»åŠ å…¨å±é¢„è§ˆåŠŸèƒ½
        function showFullscreenPreview(imageSrc) {
            // åˆ›å»ºå…¨å±é¢„è§ˆå®¹å™¨
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.className = 'fullscreen-preview';
            
            // åˆ›å»ºå›¾ç‰‡
            const img = document.createElement('img');
            img.src = imageSrc;
            
            // åˆ›å»ºå…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.className = 'fullscreen-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = function() {
                document.body.removeChild(fullscreenDiv);
            };
            
            // ç‚¹å‡»èƒŒæ™¯ä¹Ÿå¯å…³é—­
            fullscreenDiv.onclick = function(e) {
                if (e.target === fullscreenDiv) {
                    document.body.removeChild(fullscreenDiv);
                }
            };
            
            // ç»„è£…å’Œæ˜¾ç¤º
            fullscreenDiv.appendChild(img);
            fullscreenDiv.appendChild(closeBtn);
            document.body.appendChild(fullscreenDiv);
        }

        // ä¿®å¤"Cannot set properties of null (setting 'disabled')"é”™è¯¯
        function fixDisabledPropertyError() {
            console.log("å¼€å§‹ä¿®å¤disabledå±æ€§é”™è¯¯...");
            
            // å®‰å…¨åœ°è®¾ç½®å…ƒç´ å±æ€§çš„è¾…åŠ©å‡½æ•°
            window.safeSetProperty = function(element, property, value) {
                if (!element) {
                    console.warn(`å°è¯•è®¾ç½®å±æ€§æ—¶å…ƒç´ ä¸ºnull, å±æ€§: ${property}`);
                    return false;
                }
                
                try {
                    element[property] = value;
                    return true;
                } catch (error) {
                    console.error(`è®¾ç½®å±æ€§${property}æ—¶å‡ºé”™:`, error);
                    return false;
                }
            };
            
            // é€šè¿‡IDå®‰å…¨è®¾ç½®å…ƒç´ å±æ€§
            window.safeSetPropertyById = function(id, property, value) {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`æœªæ‰¾åˆ°IDä¸º${id}çš„å…ƒç´ ï¼Œæ— æ³•è®¾ç½®${property}å±æ€§`);
                    return false;
                }
                return safeSetProperty(element, property, value);
            };
                   
            
            // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆååˆ›å»ºæŒ‰é’®
            if (document.readyState === 'complete') {

                updateConvertButtonState();
            } else {
                window.addEventListener('load', function() {

                    updateConvertButtonState();
                });
            }
            
            // åœ¨createScreenshotå‡½æ•°æœ«å°¾æ·»åŠ çŠ¶æ€æ›´æ–°
            const originalCreateScreenshot = window.createScreenshot;
            if (typeof originalCreateScreenshot === 'function') {
                window.createScreenshot = function() {
                    const result = originalCreateScreenshot.apply(this, arguments);

                    updateConvertButtonState();
                    return result;
                };
            }
            
            console.log("disabledå±æ€§é”™è¯¯ä¿®å¤å®Œæˆ");
        }

        // ä¿®å¤updateConvertButtonStateå‡½æ•°
        function updateConvertButtonState() {
            try { 
                const convertBtn = document.getElementById('convertBtn');
                if (!convertBtn) {
                    console.warn("æœªæ‰¾åˆ°è½¬æ¢æŒ‰é’®ï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°");
                    return;
                }
                
                const screenshots = document.getElementsByClassName('preview-image');
                console.info("screenshots.length:"+screenshots.length);
                if (screenshots.length > 0) {
                    convertBtn.disabled = false;
                    convertBtn.style.opacity = '1';
                    convertBtn.style.cursor = 'pointer';
                    convertBtn.style.display = 'inline-block';
                } else {
                    convertBtn.disabled = true;
                    convertBtn.style.opacity = '0.6';
                    convertBtn.style.cursor = 'not-allowed';
                }
            } catch (error) {
                console.error("æ›´æ–°æŒ‰é’®çŠ¶æ€æ—¶å‡ºé”™:", error);
            }
        }

        // ç«‹å³æ‰§è¡Œä¿®å¤
        //fixDisabledPropertyError();

        // å»¶è¿Ÿåè®¾ç½®Canvasæ ·å¼
        setTimeout(function() {
            window.safeSetCanvasStyles();
        }, 2000);
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "PDF to Excel Converter",
      "applicationCategory": "Productivity",
      "operatingSystem": "Web",
      "description": "Free online tool to convert PDF files to Excel spreadsheets by selecting table areas and using OCR.",
      "url": "https://yourdomain.com/pdf2excel.html",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.5",
        "reviewCount": "150"
      }
    }
    </script>
</body>
</html>